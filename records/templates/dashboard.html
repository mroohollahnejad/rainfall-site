{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø±Ù†Ø¯Ú¯ÛŒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css" />
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .dashboard-container { max-width: 1100px; margin: auto; }
        table { font-size: 14px; }
        td[contenteditable="true"] { background-color: #fff8e1; cursor: pointer; }
        td.editing { outline: 2px solid #007bff; }
        input.inline-input {
            width: 120px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="dashboard-container">
    <h3 class="mb-4 text-center">ğŸ“Š Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø±Ù†Ø¯Ú¯ÛŒ</h3>

    <!-- ÙÛŒÙ„ØªØ± -->
    <form method="get" class="row mb-4 g-2">
        <div class="col-md-4">
            <select name="station" class="form-select">
                <option value="all">Ù‡Ù…Ù‡ Ø§ÛŒØ³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</option>
                {% for s in stations %}
                    <option value="{{ s.id }}" {% if s.id|stringformat:"s" == station_filter %}selected{% endif %}>
                        {{ s.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <input type="text" name="date" class="form-control" placeholder="ØªØ§Ø±ÛŒØ® (YYYY/MM/DD)" value="{{ date_filter }}">
        </div>
        <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>
        </div>
    </form>

    <!-- Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-responsive">
        <table id="rainTable" class="table table-bordered table-striped text-center">
            <thead class="table-dark">
                <tr>
                    <th>Ø§ÛŒØ³ØªÚ¯Ø§Ù‡</th>
                    <th>ØªØ§Ø±ÛŒØ®</th>
                    <th>Ø³Ø§Ø¹Øª</th>
                    <th>Ù…ÛŒØ²Ø§Ù† Ø¨Ø§Ø±Ø´ (Ù…ÛŒÙ„ÛŒÙ…ØªØ±)</th>
                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for r in records %}
                    <tr data-id="{{ r.id }}">
                        <td>{{ r.station.name }}</td>
                        <td {% if r.user == request.user %}class="editable" data-field="date"{% endif %}>
                            {{ r.timestamp|date:"Y/m/d" }}
                        </td>
                        <td {% if r.user == request.user %}class="editable" data-field="time"{% endif %}>
                            {{ r.timestamp|date:"H:i" }}
                        </td>
                        <td {% if r.user == request.user %}contenteditable="true"{% endif %} data-field="rainfall_mm">
                            {{ r.rainfall_mm }}
                        </td>
                        <td>
                            {% if r.user == request.user %}
                                <a href="{% url 'delete_record' r.id %}" class="btn btn-sm btn-danger"
                                   onclick="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')">ğŸ—‘ï¸</a>
                            {% else %}
                                <span class="text-muted">â›”</span>
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="5" class="text-muted">ğŸ“­ Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="text-center mt-4 d-flex flex-column gap-2">
        <a href="{% url 'enter' %}" class="btn btn-success">â• Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯</a>
        <a href="{% url 'export_excel' %}" class="btn btn-secondary">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ Excel</a>
        <a href="{% url 'logout' %}" class="btn btn-danger">ğŸšª Ø®Ø±ÙˆØ¬</a>
    </div>
</div>

<!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>

<script>
    $(document).ready(function () {
        // DataTable
        $('#rainTable').DataTable({
            language: {
                search: "ğŸ” Ø¬Ø³ØªØ¬Ùˆ:",
                lengthMenu: "Ù†Ù…Ø§ÛŒØ´ _MENU_ Ø±Ú©ÙˆØ±Ø¯",
                info: "Ù†Ù…Ø§ÛŒØ´ _START_ ØªØ§ _END_ Ø§Ø² _TOTAL_ Ø±Ú©ÙˆØ±Ø¯",
                infoEmpty: "Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡",
                paginate: { first: "Ø§ÙˆÙ„", last: "Ø¢Ø®Ø±", next: "Ø¨Ø¹Ø¯ÛŒ", previous: "Ù‚Ø¨Ù„ÛŒ" }
            },
            pageLength: 10,
            order: [[1, "desc"]]
        });

        // ÙˆÛŒØ±Ø§ÛŒØ´ Ø¹Ø¯Ø¯ Ø¨Ø§Ø±Ø´
        $('td[contenteditable="true"]').on('focus', function() {
            $(this).addClass('editing');
        }).on('blur', function() {
            $(this).removeClass('editing');
            const newValue = $(this).text().trim();
            const field = $(this).data('field');
            const recordId = $(this).closest('tr').data('id');
            sendUpdate(recordId, field, newValue);
        });

        // ÙˆÛŒØ±Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®
        $('td.editable[data-field="date"]').on('click', function () {
            const td = $(this);
            const currentVal = td.text().trim();
            const input = $('<input class="inline-input">').val(currentVal);
            td.html(input);
            input.persianDatepicker({
                format: 'YYYY/MM/DD',
                autoClose: true,
                onSelect: function (unix) {
                    const newValue = input.val();
                    const recordId = td.closest('tr').data('id');
                    sendUpdate(recordId, 'date', newValue);
                    td.text(newValue);
                }
            });
            input.focus();
        });

        // ÙˆÛŒØ±Ø§ÛŒØ´ Ø³Ø§Ø¹Øª
        $('td.editable[data-field="time"]').on('click', function () {
            const td = $(this);
            const currentVal = td.text().trim();
            const input = $('<input class="inline-input" type="time">').val(currentVal);
            td.html(input);
            input.on('blur', function () {
                const newValue = input.val();
                const recordId = td.closest('tr').data('id');
                sendUpdate(recordId, 'time', newValue);
                td.text(newValue);
            });
            input.focus();
        });

        function sendUpdate(recordId, field, value) {
            $.ajax({
                url: "{% url 'inline_update' %}",
                method: "POST",
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                data: { id: recordId, field: field, value: value },
                success: function (resp) {
                    console.log("âœ… ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
                },
                error: function () {
                    alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª");
                }
            });
        }
    });
</script>

</body>
</html>
