{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">

    <h2 class="mb-3">داشبورد بارش سه‌ساعته</h2>

    <form method="get" class="row g-3 mb-4 align-items-end">

        <div class="col-md-3">
            <label class="form-label"><strong>ایستگاه</strong></label>
            <select name="station" class="form-select">
                <option value="all">همه ایستگاه‌ها</option>
                {% for st in stations %}
                <option value="{{ st.id }}" {% if st.id|stringformat:"s" == station_filter %}selected{% endif %}>{{ st.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label"><strong>تاریخ آغاز</strong></label>
            <input type="text" name="start_date" id="start_date" class="form-control" placeholder="YYYY/MM/DD" value="{{ start_date }}">
        </div>

        <div class="col-md-3">
            <label class="form-label"><strong>تاریخ پایان</strong></label>
            <input type="text" name="end_date" id="end_date" class="form-control" placeholder="YYYY/MM/DD" value="{{ end_date }}">
        </div>

        <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
        </div>

        <div class="col-md-1 d-grid">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">پاک کردن</a>
        </div>

    </form>

    <table class="table table-bordered table-striped text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>ایستگاه</th>
                <th>تاریخ</th>
                <th>بازه سه‌ساعته</th>
                <th>میزان بارش (mm)</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody>
            {% for r in records %}
            <tr data-id="{{ r.id }}">
                <td>{{ r.station.name }}</td>
                <td>{{ r.timestamp|date:"Y/m/d" }}</td>

                <td>
                    <select class="form-select time_range">
                        {% for code,label in time_choices %}
                        <option value="{{ code }}" {% if r.time_range == code %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </td>

                <td>
                    <input type="number" step="0.1" class="form-control rainfall" value="{{ r.rainfall_mm }}">
                </td>

                <td>
                    <form method="post" action="{% url 'delete_record' r.id %}" style="display:inline-block;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('آیا مطمئن هستید؟')" class="btn btn-danger btn-sm">حذف</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="5">هیچ رکوردی یافت نشد</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="{% url 'export_excel' %}" class="btn btn-success">دانلود Excel</a>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/css/persian-datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>

<script>
$(function(){
    $('#start_date').persianDatepicker({format:'YYYY/MM/DD', autoClose:true});
    $('#end_date').persianDatepicker({format:'YYYY/MM/DD', autoClose:true});

    // Inline rainfall update
    $('.rainfall').change(function(){
        let tr = $(this).closest('tr');
        let id = tr.data('id');
        let value = $(this).val();
        $.post("{% url 'inline_update' %}", {
            id: id,
            field: 'rainfall_mm',
            value: value,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(resp){
            if(resp.status !== 'success') alert(resp.message);
        });
    });

    // Inline time_range update
    $('.time_range').change(function(){
        let tr = $(this).closest('tr');
        let id = tr.data('id');
        let value = $(this).val();
        $.post("{% url 'inline_update' %}", {
            id: id,
            field: 'time_range',
            value: value,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function(resp){
            if(resp.status !== 'success') alert(resp.message);
        });
    });
});
</script>
{% endblock %}
